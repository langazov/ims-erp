{{- if .Values.authService.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
  labels:
    app: erp-system
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.authService.replicaCount }}
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
        version: {{ .Chart.AppVersion }}
    spec:
      serviceAccountName: erp-system
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: auth-service
          image: {{ .Values.global.imageRegistry }}/{{ .Values.authService.image.repository }}:{{ .Values.authService.image.tag }}
          imagePullPolicy: {{ .Values.authService.image.pullPolicy }}
          ports:
            - containerPort: 8081
              name: http
          env:
            - name: APP_NAME
              value: {{ .Values.config.appName }}
            - name: ENVIRONMENT
              value: {{ .Values.config.environment }}
            - name: MONGODB_URI
              value: "mongodb://{{ .Values.authService.config.mongodb.host }}:{{ .Values.authService.config.mongodb.port }}/{{ .Values.authService.config.mongodb.database }}"
            - name: REDIS_ADDRESSES
              value: "{{ .Values.authService.config.redis.host }}:{{ .Values.authService.config.redis.port }}"
            - name: LOGGING_LEVEL
              value: {{ .Values.config.logLevel }}
          resources:
            {{- toYaml .Values.authService.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8081
      protocol: TCP
      name: http
  selector:
    app: auth-service
{{- end }}

{{- if .Values.clientCommandService.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: client-command-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
  labels:
    app: erp-system
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.clientCommandService.replicaCount }}
  selector:
    matchLabels:
      app: client-command-service
  template:
    metadata:
      labels:
        app: client-command-service
        version: {{ .Chart.AppVersion }}
    spec:
      serviceAccountName: erp-system
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: client-command-service
          image: {{ .Values.global.imageRegistry }}/{{ .Values.clientCommandService.image.repository }}:{{ .Values.clientCommandService.image.tag }}
          imagePullPolicy: {{ .Values.clientCommandService.image.pullPolicy }}
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: APP_NAME
              value: {{ .Values.config.appName }}
            - name: ENVIRONMENT
              value: {{ .Values.config.environment }}
            - name: MONGODB_URI
              value: "mongodb://{{ .Values.clientCommandService.config.mongodb.host }}:{{ .Values.clientCommandService.config.mongodb.port }}/{{ .Values.clientCommandService.config.mongodb.database }}"
            - name: REDIS_ADDRESSES
              value: "{{ .Values.clientCommandService.config.redis.host }}:{{ .Values.clientCommandService.config.redis.port }}"
            - name: NATS_URL
              value: "nats://{{ .Values.clientCommandService.config.nats.host }}:{{ .Values.clientCommandService.config.nats.port }}"
            - name: LOGGING_LEVEL
              value: {{ .Values.config.logLevel }}
          resources:
            {{- toYaml .Values.clientCommandService.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: client-command-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app: client-command-service
{{- end }}

{{- if .Values.clientQueryService.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: client-query-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
  labels:
    app: erp-system
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.clientQueryService.replicaCount }}
  selector:
    matchLabels:
      app: client-query-service
  template:
    metadata:
      labels:
        app: client-query-service
        version: {{ .Chart.AppVersion }}
    spec:
      serviceAccountName: erp-system
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: client-query-service
          image: {{ .Values.global.imageRegistry }}/{{ .Values.clientQueryService.image.repository }}:{{ .Values.clientQueryService.image.tag }}
          imagePullPolicy: {{ .Values.clientQueryService.image.pullPolicy }}
          ports:
            - containerPort: 8082
              name: http
          env:
            - name: APP_NAME
              value: {{ .Values.config.appName }}
            - name: ENVIRONMENT
              value: {{ .Values.config.environment }}
            - name: MONGODB_URI
              value: "mongodb://{{ .Values.clientQueryService.config.mongodb.host }}:{{ .Values.clientQueryService.config.mongodb.port }}/{{ .Values.clientQueryService.config.mongodb.database }}"
            - name: REDIS_ADDRESSES
              value: "{{ .Values.clientQueryService.config.redis.host }}:{{ .Values.clientQueryService.config.redis.port }}"
            - name: NATS_URL
              value: "nats://{{ .Values.clientQueryService.config.nats.host }}:{{ .Values.clientQueryService.config.nats.port }}"
            - name: LOGGING_LEVEL
              value: {{ .Values.config.logLevel }}
          resources:
            {{- toYaml .Values.clientQueryService.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: client-query-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8082
      protocol: TCP
      name: http
  selector:
    app: client-query-service
{{- end }}

{{- if .Values.invoiceService.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: invoice-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
  labels:
    app: erp-system
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.invoiceService.replicaCount }}
  selector:
    matchLabels:
      app: invoice-service
  template:
    metadata:
      labels:
        app: invoice-service
        version: {{ .Chart.AppVersion }}
    spec:
      serviceAccountName: erp-system
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: invoice-service
          image: {{ .Values.global.imageRegistry }}/{{ .Values.invoiceService.image.repository }}:{{ .Values.invoiceService.image.tag }}
          imagePullPolicy: {{ .Values.invoiceService.image.pullPolicy }}
          ports:
            - containerPort: 8083
              name: http
          env:
            - name: APP_NAME
              value: {{ .Values.config.appName }}
            - name: ENVIRONMENT
              value: {{ .Values.config.environment }}
            - name: MONGODB_URI
              value: "mongodb://{{ .Values.invoiceService.config.mongodb.host }}:{{ .Values.invoiceService.config.mongodb.port }}/{{ .Values.invoiceService.config.mongodb.database }}"
            - name: REDIS_ADDRESSES
              value: "{{ .Values.invoiceService.config.redis.host }}:{{ .Values.invoiceService.config.redis.port }}"
            - name: NATS_URL
              value: "nats://{{ .Values.invoiceService.config.nats.host }}:{{ .Values.invoiceService.config.nats.port }}"
            - name: LOGGING_LEVEL
              value: {{ .Values.config.logLevel }}
          resources:
            {{- toYaml .Values.invoiceService.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: invoice-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8083
      protocol: TCP
      name: http
  selector:
    app: invoice-service
{{- end }}

{{- if .Values.paymentService.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
  labels:
    app: erp-system
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.paymentService.replicaCount }}
  selector:
    matchLabels:
      app: payment-service
  template:
    metadata:
      labels:
        app: payment-service
        version: {{ .Chart.AppVersion }}
    spec:
      serviceAccountName: erp-system
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: payment-service
          image: {{ .Values.global.imageRegistry }}/{{ .Values.paymentService.image.repository }}:{{ .Values.paymentService.image.tag }}
          imagePullPolicy: {{ .Values.paymentService.image.pullPolicy }}
          ports:
            - containerPort: 8084
              name: http
          env:
            - name: APP_NAME
              value: {{ .Values.config.appName }}
            - name: ENVIRONMENT
              value: {{ .Values.config.environment }}
            - name: MONGODB_URI
              value: "mongodb://{{ .Values.paymentService.config.mongodb.host }}:{{ .Values.paymentService.config.mongodb.port }}/{{ .Values.paymentService.config.mongodb.database }}"
            - name: REDIS_ADDRESSES
              value: "{{ .Values.paymentService.config.redis.host }}:{{ .Values.paymentService.config.redis.port }}"
            - name: NATS_URL
              value: "nats://{{ .Values.paymentService.config.nats.host }}:{{ .Values.paymentService.config.nats.port }}"
            - name: LOGGING_LEVEL
              value: {{ .Values.config.logLevel }}
          resources:
            {{- toYaml .Values.paymentService.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: payment-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8084
      protocol: TCP
      name: http
  selector:
    app: payment-service
{{- end }}

{{- if .Values.productService.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: product-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
  labels:
    app: erp-system
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.productService.replicaCount }}
  selector:
    matchLabels:
      app: product-service
  template:
    metadata:
      labels:
        app: product-service
        version: {{ .Chart.AppVersion }}
    spec:
      serviceAccountName: erp-system
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: product-service
          image: {{ .Values.global.imageRegistry }}/{{ .Values.productService.image.repository }}:{{ .Values.productService.image.tag }}
          imagePullPolicy: {{ .Values.productService.image.pullPolicy }}
          ports:
            - containerPort: 8085
              name: http
          env:
            - name: APP_NAME
              value: {{ .Values.config.appName }}
            - name: ENVIRONMENT
              value: {{ .Values.config.environment }}
            - name: MONGODB_URI
              value: "mongodb://{{ .Values.productService.config.mongodb.host }}:{{ .Values.productService.config.mongodb.port }}/{{ .Values.productService.config.mongodb.database }}"
            - name: REDIS_ADDRESSES
              value: "{{ .Values.productService.config.redis.host }}:{{ .Values.productService.config.redis.port }}"
            - name: NATS_URL
              value: "nats://{{ .Values.productService.config.nats.host }}:{{ .Values.productService.config.nats.port }}"
            - name: ELASTICSEARCH_URL
              value: "http://{{ .Values.productService.config.elasticsearch.host }}:{{ .Values.productService.config.elasticsearch.port }}"
            - name: LOGGING_LEVEL
              value: {{ .Values.config.logLevel }}
          resources:
            {{- toYaml .Values.productService.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: product-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8085
      protocol: TCP
      name: http
  selector:
    app: product-service
{{- end }}

{{- if .Values.orderService.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
  labels:
    app: erp-system
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.orderService.replicaCount }}
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
        version: {{ .Chart.AppVersion }}
    spec:
      serviceAccountName: erp-system
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: order-service
          image: {{ .Values.global.imageRegistry }}/{{ .Values.orderService.image.repository }}:{{ .Values.orderService.image.tag }}
          imagePullPolicy: {{ .Values.orderService.image.pullPolicy }}
          ports:
            - containerPort: 8086
              name: http
          env:
            - name: APP_NAME
              value: {{ .Values.config.appName }}
            - name: ENVIRONMENT
              value: {{ .Values.config.environment }}
            - name: MONGODB_URI
              value: "mongodb://{{ .Values.orderService.config.mongodb.host }}:{{ .Values.orderService.config.mongodb.port }}/{{ .Values.orderService.config.mongodb.database }}"
            - name: REDIS_ADDRESSES
              value: "{{ .Values.orderService.config.redis.host }}:{{ .Values.orderService.config.redis.port }}"
            - name: NATS_URL
              value: "nats://{{ .Values.orderService.config.nats.host }}:{{ .Values.orderService.config.nats.port }}"
            - name: LOGGING_LEVEL
              value: {{ .Values.config.logLevel }}
          resources:
            {{- toYaml .Values.orderService.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: order-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8086
      protocol: TCP
      name: http
  selector:
    app: order-service
{{- end }}

{{- if .Values.inventoryService.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: inventory-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
  labels:
    app: erp-system
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.inventoryService.replicaCount }}
  selector:
    matchLabels:
      app: inventory-service
  template:
    metadata:
      labels:
        app: inventory-service
        version: {{ .Chart.AppVersion }}
    spec:
      serviceAccountName: erp-system
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: inventory-service
          image: {{ .Values.global.imageRegistry }}/{{ .Values.inventoryService.image.repository }}:{{ .Values.inventoryService.image.tag }}
          imagePullPolicy: {{ .Values.inventoryService.image.pullPolicy }}
          ports:
            - containerPort: 8087
              name: http
          env:
            - name: APP_NAME
              value: {{ .Values.config.appName }}
            - name: ENVIRONMENT
              value: {{ .Values.config.environment }}
            - name: MONGODB_URI
              value: "mongodb://{{ .Values.inventoryService.config.mongodb.host }}:{{ .Values.inventoryService.config.mongodb.port }}/{{ .Values.inventoryService.config.mongodb.database }}"
            - name: REDIS_ADDRESSES
              value: "{{ .Values.inventoryService.config.redis.host }}:{{ .Values.inventoryService.config.redis.port }}"
            - name: NATS_URL
              value: "nats://{{ .Values.inventoryService.config.nats.host }}:{{ .Values.inventoryService.config.nats.port }}"
            - name: LOGGING_LEVEL
              value: {{ .Values.config.logLevel }}
          resources:
            {{- toYaml .Values.inventoryService.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: inventory-service
  namespace: {{ .Release.Namespace | default "erp-system" }}
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 8087
      protocol: TCP
      name: http
  selector:
    app: inventory-service
{{- end }}

{{- if .Values.apiGateway.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: {{ .Release.Namespace | default "erp-system" }}
  labels:
    app: erp-system
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.apiGateway.replicaCount }}
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
        version: {{ .Chart.AppVersion }}
    spec:
      serviceAccountName: erp-system
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.global.imagePullSecrets | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: api-gateway
          image: {{ .Values.global.imageRegistry }}/{{ .Values.apiGateway.image.repository }}:{{ .Values.apiGateway.image.tag }}
          imagePullPolicy: {{ .Values.apiGateway.image.pullPolicy }}
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: APP_NAME
              value: {{ .Values.config.appName }}
            - name: ENVIRONMENT
              value: {{ .Values.config.environment }}
            - name: AUTH_SERVICE_URL
              value: "http://auth-service"
            - name: CLIENT_COMMAND_SERVICE_URL
              value: "http://client-command-service"
            - name: CLIENT_QUERY_SERVICE_URL
              value: "http://client-query-service"
            - name: INVOICE_SERVICE_URL
              value: "http://invoice-service"
            - name: PAYMENT_SERVICE_URL
              value: "http://payment-service"
            - name: PRODUCT_SERVICE_URL
              value: "http://product-service"
            - name: ORDER_SERVICE_URL
              value: "http://order-service"
            - name: INVENTORY_SERVICE_URL
              value: "http://inventory-service"
            - name: LOGGING_LEVEL
              value: {{ .Values.config.logLevel }}
          resources:
            {{- toYaml .Values.apiGateway.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: {{ .Release.Namespace | default "erp-system" }}
spec:
  type: {{ .Values.apiGateway.service.type }}
  ports:
    - port: 80
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app: api-gateway
{{- end }}
